function selectBattleMode(mode) {
    // Boss battle is only available in multiplayer mode
    if (mode === 'boss_battle' && gameState.gameMode !== 'multiplayer') {
        alert('ðŸ‰ Boss Battle is only available in 2-Player mode!\n\nPlease select 2-Player mode from the main menu first.');
        return;
    }

    gameState.selectedBattleMode = mode;
    console.log('ðŸ Battle mode selected:', mode);
    if (gameState.gameMode === 'multiplayer') {
        showCharacterSelect();
    } else {
        showCharacterSelect();
    }
}

function selectDifficulty(difficulty) {
    gameState.selectedDifficulty = difficulty;
    showMapSelect();
}

function selectMap(mapType) {
    gameState.selectedMap = mapType;
    showBattlePreparation();
}

function showMapSelect() {
    showScreen('mapSelectScreen');
}

function showMapSelectMultiplayer() {
    if (!gameState.selectedPlayer2Character) {
        showNotification('Player 2 must select a character first!');
        return;
    }
    showScreen('mapSelectScreen');
}

function showDifficultySelect() {
    if (!gameState.selectedCharacter) {
        showNotification('Please select a character first!');
        return;
    }
    showScreen('difficultySelectScreen');
}

function startBattleFromPrep() {
    // Call the actual start battle function
    startBattle();
}

function endBattle() {
    if (gameState.battle) {
        gameState.battle.gameRunning = false;
        // Clean up resize event listener
        if (gameState.battle.handleResize) {
            window.removeEventListener('resize', gameState.battle.handleResize);
        }
        gameState.battle = null;
    }
    gameState.selectedCharacter = null;
    gameState.selectedPlayer2Character = null;
    gameState.selectedMap = null;

    // Show loading screen and check for completed challenges
    showLoadingScreen('battle', () => {
        // After loading screen, show appropriate screen
        if (gameState.tournamentMode && gameState.tournamentData.isActive) {
            showTournamentSelect();
        } else {
            showMainMenu();
        }
    });
}

function cancelChooseCharacter() {
    // Refund the coins since they cancelled (1500 for choose chest)
    if (gameState.gameMode === 'multiplayer') {
        if (gameState.currentShopPlayer === 1) {
            gameState.player1Coins = safeCoins(gameState.player1Coins + 1500);
        } else {
            gameState.player2Coins = safeCoins(gameState.player2Coins + 1500);
        }
        updateMultiplayerCoinsDisplay();
    } else {
        gameState.coins = safeCoins(gameState.coins + 1500);
        updateSinglePlayerCoinsDisplay();
    }

    // Clean up the choose chest state
    gameState.chooseChestAvailableChars = null;
    gameState.chooseChestAvailableBadges = null;

    // Go back to shop
    showShop();
}

function closeCharacterDetail() {
    // Stop animation
    if (danceAnimationFrame) {
        cancelAnimationFrame(danceAnimationFrame);
        danceAnimationFrame = null;
    }
    showCollection();
}

function toggleFavorite() {
    if (!gameState.currentDetailCharacter) return;

    // Initialize favorites array if it doesn't exist
    if (!gameState.favoriteCharacters) {
        gameState.favoriteCharacters = [];
    }

    const charKey = gameState.currentDetailCharacter;
    const index = gameState.favoriteCharacters.indexOf(charKey);

    if (index > -1) {
        // Remove from favorites
        gameState.favoriteCharacters.splice(index, 1);
        showNotification(`${characters[charKey].emoji} ${characters[charKey].name} removed from favorites!`);
    } else {
        // Add to favorites
        gameState.favoriteCharacters.push(charKey);
        showNotification(`${characters[charKey].emoji} ${characters[charKey].name} added to favorites! â­`);
    }

    // Update button
    updateFavoriteButton();

    // Save game state
    saveGameState();
}

function handleCharacterNext() {
    if (!gameState.selectedCharacter) {
        showNotification('Please select a character first!');
        return;
    }

    // In tournament mode, lock in the player's character for the series
    if (gameState.tournamentMode && gameState.tournamentData.isActive) {
        const series = gameState.tournamentData.currentSeries;
        if (!series.playerCharacter) {
            series.playerCharacter = gameState.selectedCharacter;
            console.log(`ðŸ”’ Player character locked for series: ${characters[gameState.selectedCharacter].name}`);
        }
    }

    // In 2-player tournament mode, lock in the current player's character for the series
    if (gameState.tournament2PlayerMode && gameState.tournament2PlayerData.isActive) {
        const data = gameState.tournament2PlayerData;
        const currentPlayerData = data.currentPlayer === 1 ? data.player1 : data.player2;
        const series = currentPlayerData.currentSeries;

        if (!series.playerCharacter && !data.finalMatch) {
            series.playerCharacter = gameState.selectedCharacter;
            console.log(`ðŸ”’ Player ${data.currentPlayer} character locked for series: ${characters[gameState.selectedCharacter].name}`);
        }
    }

    if (gameState.gameMode === 'multiplayer') {
        showPlayer2Select();
    } else {
        showDifficultySelect();
    }
}

function returnToMainMenuWithLoading(source) {
    showLoadingScreen(source, () => {
        showMainMenu();
    });
}

function showTournamentSelect() {
    updateTournamentStatus();
    showScreen('tournamentSelectScreen');
}

function showTournamentSelect2Player() {
    update2PlayerTournamentStatus();
    showScreen('tournament2PlayerScreen');
}

function startTournament(tournamentType) {
    // Tournament configurations with character tiers and reduced rewards
    const tournaments = {
        rookie: {
            name: 'Rookie Tournament',
            entryFee: 25,
            prizePool: 75,
            rounds: 3,
            roundNames: ['Quarterfinal', 'Semifinal', 'Final'],
            characterTier: 'common',
            seriesLength: 3 // First to win 3 games
        },
        pro: {
            name: 'Pro Tournament',
            entryFee: 50,
            prizePool: 200,
            rounds: 4,
            roundNames: ['Round of 16', 'Quarterfinal', 'Semifinal', 'Final'],
            characterTier: 'rare',
            seriesLength: 3
        },
        champion: {
            name: 'Champion Tournament',
            entryFee: 100,
            prizePool: 500,
            rounds: 5,
            roundNames: ['Round of 32', 'Round of 16', 'Quarterfinal', 'Semifinal', 'Final'],
            characterTier: 'epic',
            seriesLength: 3
        },
        legendary: {
            name: 'Legendary Tournament',
            entryFee: 200,
            prizePool: 1000,
            rounds: 6,
            roundNames: ['Round of 64', 'Round of 32', 'Round of 16', 'Quarterfinal', 'Semifinal', 'Final'],
            characterTier: 'legendary',
            seriesLength: 3
        }
    };

    const tournament = tournaments[tournamentType];
    if (!tournament) return;

    // Check if player has enough coins
    let playerCoins;
    if (gameState.gameMode === 'multiplayer') {
        playerCoins = gameState.currentShopPlayer === 1 ? gameState.player1Coins : gameState.player2Coins;
    } else {
        playerCoins = gameState.coins;
    }

    if (playerCoins < tournament.entryFee) {
        showNotification(`âŒ Not enough coins!\nYou need ${tournament.entryFee} coins to enter this tournament.\nYou have ${playerCoins} coins.`);
        return;
    }

    // Deduct entry fee
    if (gameState.gameMode === 'multiplayer') {
        if (gameState.currentShopPlayer === 1) {
            gameState.player1Coins = safeCoins(gameState.player1Coins - tournament.entryFee);
        } else {
            gameState.player2Coins = safeCoins(gameState.player2Coins - tournament.entryFee);
        }
        updateMultiplayerCoinsDisplay();
    } else {
        gameState.coins = safeCoins(gameState.coins - tournament.entryFee);
        updateSinglePlayerCoinsDisplay();
    }

    // Initialize tournament
    gameState.tournamentMode = true;
    // Force normal battle mode for tournaments
    gameState.selectedBattleMode = 'normal';
    gameState.tournamentData = {
        type: tournamentType,
        name: tournament.name,
        entryFee: tournament.entryFee,
        currentRound: 0,
        totalRounds: tournament.rounds,
        roundNames: tournament.roundNames,
        prizePool: tournament.prizePool,
        characterTier: tournament.characterTier,
        seriesLength: tournament.seriesLength,
        isActive: true,
        roundsWon: 0,
        currentSeries: {
            playerWins: 0,
            opponentWins: 0,
            gamesPlayed: 0,
            playerCharacter: null,
            opponentCharacter: null
        },
        bracket: generateTournamentBracket(tournament.rounds, tournament.characterTier)
    };

    console.log(`ðŸ† Tournament started: ${tournament.name}`);
    console.log(`ðŸ’° Entry fee deducted: ${tournament.entryFee} coins`);
    console.log(`ðŸŽ¯ Prize pool: ${tournament.prizePool} coins`);

    updateTournamentStatus();
    updateUniversalCoinsDisplay();

    // Show tournament screen with start button
    showNotification(`ðŸ† ${tournament.name} Started!\nðŸ’° Entry fee: ${tournament.entryFee} coins paid\nðŸŽ¯ Prize pool: ${tournament.prizePool} coins\n\nClick "Start Round" to begin!`);

    // Stay on tournament screen - user will click "Start Round" button
    showTournamentSelect();
}

function start2PlayerTournament(tournamentType) {
    // Tournament configurations for 2-player mode
    const tournaments = {
        rookie: {
            name: 'Rookie 2P Tournament',
            entryFee: 25,
            prizePool: 100,
            rounds: 3,
            roundNames: ['Quarterfinal', 'Semifinal', 'Final'],
            characterTier: 'common',
            seriesLength: 3
        },
        pro: {
            name: 'Pro 2P Tournament',
            entryFee: 50,
            prizePool: 300,
            rounds: 4,
            roundNames: ['Round of 16', 'Quarterfinal', 'Semifinal', 'Final'],
            characterTier: 'rare',
            seriesLength: 3
        },
        champion: {
            name: 'Champion 2P Tournament',
            entryFee: 100,
            prizePool: 750,
            rounds: 5,
            roundNames: ['Round of 32', 'Round of 16', 'Quarterfinal', 'Semifinal', 'Final'],
            characterTier: 'epic',
            seriesLength: 3
        },
        legendary: {
            name: 'Legendary 2P Tournament',
            entryFee: 200,
            prizePool: 1500,
            rounds: 6,
            roundNames: ['Round of 64', 'Round of 32', 'Round of 16', 'Quarterfinal', 'Semifinal', 'Final'],
            characterTier: 'legendary',
            seriesLength: 3
        }
    };

    const tournament = tournaments[tournamentType];
    if (!tournament) return;

    // Check if both players have enough coins
    if (gameState.player1Coins < tournament.entryFee) {
        showNotification(`âŒ Player 1 doesn't have enough coins!\nNeeds ${tournament.entryFee} coins, has ${gameState.player1Coins} coins.`);
        return;
    }
    if (gameState.player2Coins < tournament.entryFee) {
        showNotification(`âŒ Player 2 doesn't have enough coins!\nNeeds ${tournament.entryFee} coins, has ${gameState.player2Coins} coins.`);
        return;
    }

    // Deduct entry fees from both players
    gameState.player1Coins = safeCoins(gameState.player1Coins - tournament.entryFee);
    gameState.player2Coins = safeCoins(gameState.player2Coins - tournament.entryFee);
    updateMultiplayerCoinsDisplay();

    // Initialize 2-player tournament
    gameState.tournament2PlayerMode = true;
    // Force normal battle mode for tournaments
    gameState.selectedBattleMode = 'normal';
    gameState.tournament2PlayerData = {
        type: tournamentType,
        name: tournament.name,
        entryFee: tournament.entryFee,
        currentRound: 0,
        totalRounds: tournament.rounds,
        roundNames: tournament.roundNames,
        prizePool: tournament.prizePool,
        characterTier: tournament.characterTier,
        seriesLength: tournament.seriesLength,
        isActive: true,

        player1: {
            roundsWon: 0,
            isEliminated: false,
            currentSeries: {
                playerWins: 0,
                opponentWins: 0,
                gamesPlayed: 0,
                playerCharacter: null,
                opponentCharacter: null
            }
        },
        player2: {
            roundsWon: 0,
            isEliminated: false,
            currentSeries: {
                playerWins: 0,
                opponentWins: 0,
                gamesPlayed: 0,
                playerCharacter: null,
                opponentCharacter: null
            }
        },

        currentPlayer: 1,
        bracket: generate2PlayerBracket(tournament.rounds),
        finalMatch: false
    };

    console.log(`ðŸ† 2-Player Tournament started: ${tournament.name}`);
    console.log(`ðŸ’° Entry fees deducted: ${tournament.entryFee} coins each`);
    console.log(`ðŸŽ¯ Prize pool: ${tournament.prizePool} coins`);

    update2PlayerTournamentStatus();
    updateUniversalCoinsDisplay();

    showNotification(`ðŸ† ${tournament.name} Started!\n\nðŸ’° Entry fees: ${tournament.entryFee} coins each paid\nðŸŽ¯ Prize pool: ${tournament.prizePool} coins\n\nPlayer 1 starts first!\nClick "Start Round" to begin!`);

    // Stay on tournament screen - user will click "Start Round" button
    showTournamentSelect2Player();
}

function forfeitTournament() {
    if (!gameState.tournamentMode || !gameState.tournamentData.isActive) {
        showNotification('No active tournament to forfeit.');
        return;
    }

    const data = gameState.tournamentData;

    // Confirm forfeit
    if (confirm(`Are you sure you want to forfeit the ${data.name}?\n\nYou will lose your entry fee (${data.entryFee} coins) and receive no prize.`)) {
        // Reset tournament
        gameState.tournamentMode = false;
        gameState.tournamentData.isActive = false;

        showNotification(`ðŸ³ï¸ Tournament Forfeited!\n\n${data.name} has been abandoned.\nEntry fee (${data.entryFee} coins) lost.\n\nYou can now start new battles.`);

        updateTournamentStatus();
        updateUniversalCoinsDisplay();

        // Return to main menu
        setTimeout(() => {
            showMainMenu();
        }, 3000);
    }
}

function forfeit2PlayerTournament() {
    if (!gameState.tournament2PlayerMode || !gameState.tournament2PlayerData.isActive) {
        showNotification('No active 2-player tournament to forfeit.');
        return;
    }

    const data = gameState.tournament2PlayerData;

    if (confirm(`Are you sure you want to forfeit the ${data.name}?\n\nBoth players will lose their entry fees (${data.entryFee} coins each) and receive no prize.`)) {
        gameState.tournament2PlayerMode = false;
        gameState.tournament2PlayerData.isActive = false;

        showNotification(`ðŸ³ï¸ 2-Player Tournament Forfeited!\n\n${data.name} has been abandoned.\nEntry fees (${data.entryFee} coins each) lost.\n\nYou can now start new battles.`);

        update2PlayerTournamentStatus();
        updateUniversalCoinsDisplay();

        setTimeout(() => {
            showMainMenu();
        }, 3000);
    }
}